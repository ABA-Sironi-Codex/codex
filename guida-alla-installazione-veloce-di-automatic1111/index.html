<!DOCTYPE html><html lang="it"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Guida alla installazione veloce di Automatic1111 (Windows+Nvidia GPU) - Codex</title><meta name="description" content="Link alla guida per le installazioni veloci di Automatic1111 sotto Windows (solo Nvidia GPU)"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="stylesheet" href="https://codex.accademiasironi.it/media/plugins/syntaxHighlighter/prism-white.css"><link rel="stylesheet" href="https://codex.accademiasironi.it/media/plugins/syntaxHighlighter/prism-inline-color.css"><link rel="canonical" href="https://codex.accademiasironi.it/guida-alla-installazione-veloce-di-automatic1111/"><link rel="alternate" type="application/atom+xml" href="https://codex.accademiasironi.it/feed.xml"><link rel="alternate" type="application/json" href="https://codex.accademiasironi.it/feed.json"><meta property="og:title" content="Guida alla installazione veloce di Automatic1111 (Windows+Nvidia GPU) - Codex "><meta property="og:image" content="https://codex.accademiasironi.it/media/posts/2/011_GuidaInstallazioniStableD-2.webp"><meta property="og:image:width" content="1236"><meta property="og:image:height" content="966"><meta property="og:site_name" content="Codex"><meta property="og:description" content="Link alla guida per le installazioni veloci di Automatic1111 sotto Windows (solo Nvidia GPU)"><meta property="og:url" content="https://codex.accademiasironi.it/guida-alla-installazione-veloce-di-automatic1111/"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@DavideRiboli"><meta name="twitter:title" content="Guida alla installazione veloce di Automatic1111 (Windows+Nvidia GPU) - Codex "><meta name="twitter:description" content="Link alla guida per le installazioni veloci di Automatic1111 sotto Windows (solo Nvidia GPU)"><meta name="twitter:image" content="https://codex.accademiasironi.it/media/posts/2/011_GuidaInstallazioniStableD-2.webp"><link rel="shortcut icon" href="https://codex.accademiasironi.it/media/website/favicon.png" type="image/png"><link rel="stylesheet" href="https://codex.accademiasironi.it/assets/css/style.css?v=9d4e95dba5ce5d10722ed7ba7249a484"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://codex.accademiasironi.it/guida-alla-installazione-veloce-di-automatic1111/"},"headline":"Guida alla installazione veloce di Automatic1111 (Windows+Nvidia GPU)","datePublished":"2023-11-30T17:29","dateModified":"2023-12-13T01:11","image":{"@type":"ImageObject","url":"https://codex.accademiasironi.it/media/posts/2/011_GuidaInstallazioniStableD-2.webp","height":966,"width":1236},"description":"Link alla guida per le installazioni veloci di Automatic1111 sotto Windows (solo Nvidia GPU)","author":{"@type":"Person","name":"Marika Ambrosino & Anna Maria Sanna","url":"https://codex.accademiasironi.it/authors/marika-ambrosino-and-anna-maria-sanna/"},"publisher":{"@type":"Organization","name":"Prof. Davide Riboli","logo":{"@type":"ImageObject","url":"https://codex.accademiasironi.it/media/website/logo.png","height":480,"width":480}}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-RL28EM6KVR"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-RL28EM6KVR');</script></head><body><header class="header" id="js-header"><a class="logo" href="https://codex.accademiasironi.it/"><img src="https://codex.accademiasironi.it/media/website/logo.png" alt="Codex" width="480" height="480"></a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://codex.accademiasironi.it/" title="Home" target="_self">Home</a></li><li><a href="https://codex.accademiasironi.it/tag/" title="Tag Index" target="_self">Tag Index</a></li><li><a href="https://codex.accademiasironi.it/info/" title="Info" target="_self">Info</a></li><li><a href="https://forms.gle/uYitLWT8V9AHiD5d9" title="Newsletter" target="_self">Newsletter</a></li></ul></nav><a href="https://github.com/ABA-Sironi-Codex" class="btn btn--outline btn--icon github" aria-label="Github" title="Github"><svg height="22" width="22"><use xlink:href="https://codex.accademiasironi.it/assets/svg/svg-map.svg#github"></use></svg> Github</a></header><main><div class="container"><div class="content content--center"><article class="post post-blog"><header class="post-blog__header"><h1>Guida alla installazione veloce di Automatic1111 (Windows+Nvidia GPU)</h1><ul class="post-blog__meta"><li><address class="post-blog__author"><img src="https://codex.accademiasironi.it/media/website/avatrmarikanna.png" loading="eager" height="100" width="200" alt="Marika Ambrosino &amp; Anna Maria Sanna"> <a rel="author" href="https://codex.accademiasironi.it/authors/marika-ambrosino-and-anna-maria-sanna/">Marika Ambrosino &amp; Anna Maria Sanna</a></address></li><li><time datetime="2023-12-13T01:11">13 dicembre 2023</time></li><li>Pubblicato in: <a href="https://codex.accademiasironi.it/tag/automatic1111/" class="post-blog__tag">Automatic1111</a></li></ul></header><figure class="post__featured-image"><img src="https://codex.accademiasironi.it/media/posts/2/011_GuidaInstallazioniStableD-2.webp" srcset="https://codex.accademiasironi.it/media/posts/2/responsive/011_GuidaInstallazioniStableD-2-xs.webp 300w, https://codex.accademiasironi.it/media/posts/2/responsive/011_GuidaInstallazioniStableD-2-sm.webp 480w, https://codex.accademiasironi.it/media/posts/2/responsive/011_GuidaInstallazioniStableD-2-md.webp 749w" sizes="(max-width: 749px) 100vw, 749px" loading="eager" height="966" width="1236" alt="Automatic1111 GUI"><figcaption>Automatic1111 GUI https://github.com/AUTOMATIC1111/stable-diffusion-webui</figcaption></figure><div class="post__entry"><p><a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui" target="_blank" rel="nofollow noopener noreferrer">Automatic1111 Web UI</a> - spesso abbreviata in Automatic1111 o A1111 - è una delle più diffuse interfacce di controllo per <a href="https://stability.ai/stable-diffusion" target="_blank" rel="nofollow noopener noreferrer">Stable Diffusion</a>. Oltre alle consuete operazioni di generazione <em>Text-2-Image</em>, la sua struttura modulare permette una infinità di operazioni accessorie come, solo per fare alcuni esempi, la generazione di matrici di miniature per confrontare la differenza ottenuta con la variazione di questo o quel parametro, la creazione di video e di musica, etc.</p><div class="post__toc"><h3>Sommario</h3><ul><li><a href="#mcetoc_1hhg849ibci">Installazione su Ms Windows con GPU Nvidia</a></li><li><a href="#mcetoc_1hhg849ibcj">Configurazioni extra via COMMANDLINE_ARGS</a></li><li><a href="#mcetoc_1hhg849ibck">Risoluzione dei problemi</a></li><li><a href="#mcetoc_1hhg849ibcl">Installazione su Ms Windows con GPU AMD</a></li><li><a href="#mcetoc_1hhg849ibcm">Installazione su Apple Macintosh</a></li></ul></div><p>Il <em>repository </em>ufficiale contiene istruzioni molto dettagliate sugli step di installazione sotto qualsiasi genere di sistema operativo. Queste procedure variano (o potrebbero variare) ad ogni nuovo rilascio e si consiglia di verificarle direttamente alla fonte.<a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui/wiki" target="_blank" rel="nofollow noopener noreferrer"></a></p><ul><li><a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui/wiki" target="_blank" rel="nofollow noopener noreferrer">A1111 Installation Instructions</a></li></ul><p>Quelle che seguono sono le istruzioni per installazioni rapide su computer i cui requisiti si sia certi che soddisfano le richieste del sistema.</p><h3 id="mcetoc_1hhg849ibci">Installazione su Ms Windows con GPU Nvidia</h3><ol><li>Scaricate il file <em>sd.webui.zip</em> da <a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui/releases/tag/v1.0.0-pre" target="_blank" rel="nofollow noopener noreferrer">qui </a>(probabilmente andrà aggiornato, ma lo faremo al punto 3).</li><li>Estrarre il file zip nella posizione desiderata.</li><li>Doppio clic su <em>update.bat</em> per aggiornare tutto all'ultima versione, attendere il completamento dell'operazione e chiudere la finestra.</li><li>Doppio clic su <em>run.bat</em> per avviare l'interfaccia web; durante il primo avvio verrà scaricata una grande quantità di file. Dopo che tutto è stato scaricato e installato correttamente, dovrebbe apparire il messaggio<em> Esecuzione su URL locale: http://127.0.0.1:7860</em>; aprendo il link si accede all'interfaccia di controllo ed è possibile iniziare a generare immagini su <em>prompt </em>di testo.</li></ol><h3 id="mcetoc_1hhg849ibcj">Configurazioni extra via COMMANDLINE_ARGS</h3><p>È possibile configurare alcune opzioni modificando lo <em>script </em>di lancio che si trova in <em>sd.webui\webui\webui-user.bat</em>, aggiungendo gli argomenti desiderati dopo <em>COMMANDLINE_ARGS=</em>. Ad esempio:</p><pre class="bash"><code>set COMMANDLINE_ARGS=--autolaunch --update-check</code></pre><p>configura l'interfaccia in modo che venga avviata automaticamente la pagina del browser al termine del caricamento e che venga verificata la presenza di aggiornamenti all'avvio.</p><h3 id="mcetoc_1hhg849ibck">Risoluzione dei problemi</h3><p>La configurazione predefinita dell'interfaccia web dovrebbe funzionare sulla maggior parte delle moderne GPU, ma in alcuni casi potrebbero essere necessari alcuni argomenti aggiuntivi.</p><ul><li>Per le GPU con una quantità inferiore di VRAM, potrebbero essere necessari <em>--medvram</em> o <em>--lowvram</em>; queste ottimizzazioni riducono i requisiti di VRAM, sacrificando proporzionalmente le prestazioni. Se la VRAM non è sufficiente, l'interfaccia web potrebbe rifiutarsi di avviarsi o non generare immagini a causa di un errore di esaurimento della memoria. La quantità di VRAM richiesta dipende in larga misura dalla risoluzione dell'immagine desiderata; per maggiori dettagli, consultate la pagina di <a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui/wiki/Troubleshooting" target="_blank" rel="nofollow noopener noreferrer">Troubleshooting ufficiale</a>. Anche l'estensione <a href="https://github.com/pkuliyi2015/multidiffusion-upscaler-for-automatic1111" target="_blank" rel="nofollow noopener noreferrer">Tiled VAE</a> può aiutare a ridurre i requisiti di VRAM.</li><li>Se le immagini generate sono neri o verdi, provare ad aggiungere <em>--precision full</em> e <em>--no-half</em> ai parametri di lancio.</li><li>Alcune combinazioni di modello/VAE sono inclini all'errore <em>NansException: A tensor with all NaNs was produced in VAE</em> che finisce col dar luogo a un'immagine nera; l'uso dell'opzione <em>--no-half-vae</em> può contribuire a mitigare il problema.</li><li>Per ulteriori ottimizzazioni consultate le pagine ufficiali <a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui/wiki/Optimizations" rel="nofollow">Optimization</a> e <a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui/wiki/Command-Line-Arguments-and-Settings" target="_blank" rel="nofollow noopener noreferrer">Command Line Arguments and Setting</a>.</li></ul><h3 id="mcetoc_1hhg849ibcl">Installazione su Ms Windows con GPU AMD</h3><p>Per il momento, A1111 non supporta ufficialmente AMD. È comunque possibile riuscire a installarne una versione sperimentale attraverso il <em>fork</em> creato da Lshqqytiger. Il repository offre anche una guida molto dettagliata.</p><ul><li><a href="https://github.com/lshqqytiger/stable-diffusion-webui-directml" target="_blank" rel="nofollow noopener noreferrer">Lshqqytiger Stable-Diffusion-WebUI-DirectMl</a></li></ul><h3 id="mcetoc_1hhg849ibcm">Installazione su Apple Macintosh</h3><p>L'installazione sotto Mac è possibile, ma richiede molti passaggi intermedi. Fate riferimento alla guida ufficiale:</p><ul><li><a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui/wiki/Installation-on-Apple-Silicon" target="_blank" rel="nofollow noopener noreferrer">Installation on Apple Silicon</a><br><br><br><br></li></ul><footer><dl class="post__tag post-blog__tag"><dt>Tag:</dt><dd><a href="https://codex.accademiasironi.it/tag/automatic1111/" title="Automatic1111">Automatic1111</a></dd><dd><a href="https://codex.accademiasironi.it/tag/stable-diffusion/" title="Stable Diffusion">Stable Diffusion</a></dd></dl></footer></div></article><div class="banner banner--after-post"><p>&nbsp;</p><script src="https://giscus.app/client.js" data-repo="ABA-Sironi-Codex/codex" data-repo-id="R_kgDOKXrmIQ" data-category="Discussioni" data-category-id="DIC_kwDOKXrmIc4CZxRm" data-mapping="pathname" data-strict="0" data-reactions-enabled="0" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="it" crossorigin="anonymous" async></script></div></div></div></main><footer class="footer"><div><a class="footer__logo" href="https://codex.accademiasironi.it/"><img src="https://codex.accademiasironi.it/media/website/logo.png" alt="Codex"></a></div><div><div class="footer__copy"><a href="#">↑↑↑ | Torna su | ↑↑↑</a></div><div class="footer__social"></div></div></footer><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true
   };</script><script defer="defer" src="https://codex.accademiasironi.it/assets/js/scripts.min.js?v=4e6cf1839e76dc1bb4cf5df8b29781e3"></script><script>var images = document.querySelectorAll('img[loading]');

        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><script defer="defer" src="https://codex.accademiasironi.it/assets/js/quicklink.umd.js?v=a52ee49fe4afff274f8c30fe880ddc13"></script><script>window.addEventListener('load', () =>{
      quicklink.listen();
      });</script><script defer="defer" src="https://codex.accademiasironi.it/media/plugins/syntaxHighlighter/prism.js"></script><script defer="defer" src="https://codex.accademiasironi.it/media/plugins/syntaxHighlighter/prism-line-numbers.min.js"></script><script defer="defer" src="https://codex.accademiasironi.it/media/plugins/syntaxHighlighter/clipboard.min.js"></script><script defer="defer" src="https://codex.accademiasironi.it/media/plugins/syntaxHighlighter/prism-copy-to-clipboard.min.js"></script><script defer="defer" src="https://codex.accademiasironi.it/media/plugins/syntaxHighlighter/prism-inline-color.min.js"></script><script defer="defer" src="https://codex.accademiasironi.it/media/plugins/syntaxHighlighter/prism-autolinker.min.js"></script><div class="pcb" data-behaviour="badge" data-behaviour-link="#cookie-settings" data-revision="1" data-config-ttl="90" data-debug-mode="false"><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner pcb__banner--bar"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">Anche noi usiamo i cookie</div><div id="pcb-txt" class="pcb__txt">Questo sito utilizza i cookie esclusivamente per le metriche delle visite ricevute e non esegue alcun tipo di profilazione utente, né richiede alcun dato personale.<br>Il tuo consenso ci aiuta a migliorare la pubblicazione.</div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Ok</button></div></div></div><button class="pcb__badge" aria-label="Cookie Policy" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="40" height="40" viewBox="0 0 23 23" fill="currentColor"><path d="M21.41 12.71c-.08-.01-.15 0-.22 0h-.03c-.03 0-.05 0-.08.01-.07 0-.13.01-.19.04-.52.21-1.44.19-2.02-.22-.44-.31-.65-.83-.62-1.53a.758.758 0 0 0-.27-.61.73.73 0 0 0-.65-.14c-1.98.51-3.49.23-4.26-.78-.82-1.08-.73-2.89.24-4.49.14-.23.14-.52 0-.75a.756.756 0 0 0-.67-.36c-.64.03-1.11-.1-1.31-.35-.19-.26-.13-.71-.01-1.29.04-.18.06-.38.03-.59-.05-.4-.4-.7-.81-.66C5.1 1.54 1 6.04 1 11.48 1 17.28 5.75 22 11.6 22c5.02 0 9.39-3.54 10.39-8.42.08-.4-.18-.78-.58-.87Zm-9.81 7.82c-5.03 0-9.12-4.06-9.12-9.06 0-4.34 3.05-8 7.25-8.86-.08.7.05 1.33.42 1.81.24.32.66.67 1.38.84-.76 1.86-.65 3.78.36 5.11.61.81 2.03 2 4.95 1.51.18.96.71 1.54 1.18 1.87.62.43 1.38.62 2.1.62.05 0 .09 0 .13-.01-1.23 3.64-4.7 6.18-8.64 6.18ZM13 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1Zm5.29-12.3a.99.99 0 0 1-.29-.71c0-.55.45-.99 1-.99a1 1 0 0 1 .71.3c.19.19.29.44.29.71 0 .55-.45.99-1 .99a1 1 0 0 1-.71-.3ZM9 13.5c0 .83-.67 1.5-1.5 1.5S6 14.33 6 13.5 6.67 12 7.5 12s1.5.67 1.5 1.5Zm3.25.81a.744.744 0 0 1-.06-1.05c.28-.32.75-.34 1.05-.06.31.28.33.75.05 1.06-.15.16-.35.25-.56.25-.18 0-.36-.06-.5-.19ZM8.68 7.26c.41.37.44 1 .07 1.41-.2.22-.47.33-.75.33a.96.96 0 0 1-.67-.26c-.41-.37-.44-1-.07-1.41.37-.42 1-.45 1.41-.08Zm11.48 1.88c.18-.19.52-.19.7 0 .05.04.09.1.11.16.03.06.04.12.04.19 0 .13-.05.26-.15.35-.09.1-.22.15-.35.15s-.26-.05-.35-.15a.355.355 0 0 1-.11-.16.433.433 0 0 1-.04-.19c0-.13.05-.26.15-.35Zm-4.93-1.86a.75.75 0 1 1 1.059-1.06.75.75 0 0 1-1.059 1.06Z"/></svg></button></div><script>(function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('🍪 Config not found, or configuration expired');
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('🍪 Config founded');
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('🍪 Allowed group: ' + allowedGroup);
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('🍪 Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('🍪 Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>